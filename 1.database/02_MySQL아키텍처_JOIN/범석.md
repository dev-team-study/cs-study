## MySQL 아키텍처, Join

> 김범석

## MySQL 아키텍처

MySQL 서버는 `MySQL 엔진` `Storage 엔진`으로 구성된다. 

### MySQL 엔진

> 커넥션 핸들러, SQL 파서, 전처리기, 옵티마이저가 중심을 이룬다. 

#### Storage 엔진

> 실제 데이터를 디스크 Storage에 저장하거나 디스크 Storage로부터 데이터를 읽어 오는 부분을 전담한다.
>
> **MySQL 엔진은 하나지만 스토리지 엔진은 여러개를 동시에 사용 할 수 있다.**
>
> InnoDB 및 MyISAM 엔진이 있다.

#### Handler API

> MySQL엔진이 쿼리 실행기에서 데이터를 쓰거나 읽어야 할 때, 각 Storage엔진에 쓰기 또는 읽기 요청을 하는데 이러한 요청을 Handler 요청이라고 한다. 여기서 사용하는 API를 Handler API라고 한다.
>
> *Handler API를 통해 어떠한 작업이 있었는 지 조회할 수 있다.*

### Innodb

> InnoDB는 MySQL에서 사요할 수 있는 Storage엔진 중 거의 유일하게 레코드 기반의 Lock을 제공한다. 
>
> 그렇기 때문에 동시성처리가 가능하고 안정적이며 성능이 뛰어나다는 특징을 지닌다.

##### 프라이머리 키에 의한 클러스터링 

> InnoDB의 모든 테이블은 기본적으로 프라이머리 키를 기준으로 클러스터링 되어 저장된다. 
>
> 프라이머리 키가 클러스터링 인덱스이기 때문에 프라이머리 키를 통한 레인지 스캔의 속도가 매우 빠르다는 장점을 지닌다.

##### 외래 키 지원

> 외래키에 대한 지원은 InnoDB 스토리지 엔진 레벨에서 지원하는 기능으로 MyISAM, Memory 테이블에서는 사용할 수 없다.
>
> 외래키의 경우 다음의 조건을 지켜야 한다. 
>
> - 부모 테이블과 자식 테이블 모두 해당 칼럼에 인덱스 생성 필요
> - 변경시 부모 테이블이나 자식 테이블에 데이터가 있는지 체크 
>
> 그렇기 때문에 LOCK이 여러 테이블로 전파되는데, 이로 인한 데드락 발생 확률이 높기 때문에 주의해야한다.

##### MVCC (Multi Version Concurrency Control)

> 레코드 레벨의 트랜잭션을 지원하는 DBMS가 지원하는 기능. 
>
> LOCK을 사용하지 않는 일관된 읽기를 제공하는데 큰 목적이 있다. 
>
> 특정 레코드에 대해 UPDATE가 일어날 경우 InnoDB 버퍼 풀에는 새로 변경된 값, 언두 로그에는 변경되기 이전의 값을 가지고 있다.
>
> 격리 수준이 `READ_UNCOMMITED`인 경우 InnoDB 버퍼 풀에 있는 값을 보여주며, `READ_COMMITTED`이상의 격리 수준에서는  언두 로그에 있는 값을 보여준다. 

##### Non-Locking Consistent Read(잠금 없는 일관된 읽기)

> InnoDB Storage 엔진은 MVCC 기술을 사용해 잠금을 걸지 않고 읽기 작업을 수행한다. 
>
> 격리 수준이 `SERIALIZABLE`을 제외하고는 순수한 SELECT 작업은 다른 트랜잭션의 변경 작업과 관계 없이 항상 LOCK을 대기하지 않고 바로 실행된다.



### 쿼리동작 방식

> 쿼리 실행 구조의 경우 크게 쿼리 파서, 전처리기, 옵티마이저, 실행 엔진, 핸들러로 나뉜다.

##### 쿼리 파서

> 사용자 요청으로 들어온 쿼리를 토큰으로 분리해 트리 형태의 구조로 만들어 내는 작업을 수행
>
> 만약 잘못된 쿼리 요청이 온다면 이 단계에서 발견되며 오류 메세지를 클라이언트에게 보낸다.
>
> ***토큰 : MySQL이 인식할 수 있는 최소 단위의 어휘나 기호***

##### 전처리기

> 파서 과정에서 생성된 파서 트리를 기반으로 쿼리 문장에 구조적인 문제점이 있는지 파악
>
> 테이블 이름, 컬럼 이름, 내장 함수와 같은 개체를 매핑해 해당 객체의 존재 여부와 접근 권한 확인
>
> 실제 존재하지 않거나 접근 권한이 없는 토큰의 경우 이 단계에서 걸러짐

##### 옵티마이저

> 사용자의 요청으로 들어온 쿼리를 저렴한 비용으로 바르게 처리하는 역할을 담당.

##### 실행 엔진

> 옵티마이저와 핸들러 사이에서 역할을 수행한다.
>
> 핸들러에게 요청해 받은 결과를 다른 핸들러에게 이어주는 역할을 담당.

##### 핸들러 

> 실행 엔진이 지시한 일에 대해 데이터를 디스크에 저장하거나 디스크로부터 읽어오는 역할을 담당.

## JOIN 

> Join이란 두개 이상의 테이블을 묶어 하나의 결과 집합으로 만들어 내는  과정을  말한다.
> Join에는 크게 INNER JOIN, OUTER JOIN, CROSS JOIN, SELF JOIN이 있다.

### INNER JOIN

두가지 테이블에 내용이 존재하는 경우 결과가 검색된다.

```sql
SELECT <column 목록>
FROM <기준 테이블>
	INNER JOIN <참조 테이블>
	ON <조인 조건>
[WHERE 검색 조건]
```

### OUTER JOIN
두가지 테이블 중 하나의 테이블에만 내용이 있는 경우에도 결과가 검색된다.

```sql
SELECT <column 목록>
FROM <첫번째 테이블(LEFT)>
	< LEFT | RIGHT | FULL > [OUTER] JOIN <두번째 테이블(RIGHT)>
	ON <조인 조건>
[WHERE 검색 조건]
```

LEFT OUTER JOIN의 경우 첫번째 테이블에 내용이 존재한다면 결과가 검색이 된다.
RIGHT OUTER JOIN의 경우 두번째 테이블에 내용이 존재한다면 결과가 검색이 된다.
FULL OUTER JOIN의 경우 모든 결과가 검색이 된다. 

###  CROSS JOIN
한쪽 테이블의 한 행당 다른쪽 테이블의 모든 행을 하나씩 조인한다. 

```sql
SELECT <column 목록>
FROM <첫번째 테이블>
CROSS JOIN <두번째 테이블>
```
CROSS JOIN의 결과행의 개수는 첫번째 테이블 행의 개수 * 두번째 테이블 행의 개수이다. 
*보통 Cartesian Product (카티션 곱) 이라고 한다.*


### SELF JOIN
자기자신의 테이블을 조인한다. 

```sql 
SELECT <column 목록>
FROM <테이블>
	INNER JOIN <테이블>
	ON <조인 조건>
[WHERE 검색 조건]
```

---

## Quiz

1. MySQL 서버를 구성하는 두가지의 엔진은 무엇인가요? 엔진들의 특성에 대해서 간략하게 설명해 주세요.
2. InnoDB가 가지는 특성에 대해서 3가지 정도 간략하게 설명 부탁드립니다.
3. MVCC는 어떠한 기능인지 설명해 주세요.
4. 쿼리 동작 방식에 대해서 설명을 해주세요.
5. OUTER JOIN에서 LEFT OUTER JOIN, RIGHT OUTER JOIN, FULL OUTER JOIN 은 어떠한 차이를 가지나요?